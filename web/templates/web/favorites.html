{% extends 'web/base.html' %}
{% load static %}

{% block title %}My Favorites - Django Bookstore{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900">My Favorite Books</h1>
        <p class="mt-2 text-gray-600">Books you've marked as favorites</p>
    </div>

    <!-- Favorites Grid -->
    <div id="favorites-container">
        <div class="text-center py-8">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600"></div>
            <p class="mt-2 text-gray-600">Loading favorites...</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Load favorites on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadFavorites();
    });

    async function loadFavorites() {
        try {
            const favorites = await api.getFavorites();
            displayFavorites(favorites);
        } catch (error) {
            console.error('Error loading favorites:', error);
            showError('Failed to load favorites.');
        }
    }

    function displayFavorites(favorites) {
        const container = document.getElementById('favorites-container');
        
        if (favorites.length === 0) {
            container.innerHTML = `
                <div class="text-center py-12">
                    <i class="fas fa-heart text-6xl text-gray-300 mb-4"></i>
                    <h3 class="text-xl font-semibold text-gray-600 mb-2">No favorites yet</h3>
                    <p class="text-gray-500 mb-6">Start adding books to your favorites!</p>
                    <a href="{% url 'web:home' %}" class="inline-flex items-center px-6 py-3 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors">
                        <i class="fas fa-search mr-2"></i>
                        Browse Books
                    </a>
                </div>
            `;
            return;
        }

        container.innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                ${favorites.map(favorite => createFavoriteCard(favorite)).join('')}
            </div>
        `;
    }

    function createFavoriteCard(favorite) {
        const book = favorite.book;
        return `
            <div class="bg-white rounded-lg shadow-md hover:shadow-lg transition-shadow">
                <div class="p-6">
                    <div class="aspect-w-3 aspect-h-4 mb-4">
                        ${book.cover_image ? 
                            `<img src="${book.cover_image}" alt="${book.title}" class="w-full h-48 object-cover rounded-md">` :
                            `<div class="w-full h-48 bg-gray-200 rounded-md flex items-center justify-center">
                                <i class="fas fa-book text-4xl text-gray-400"></i>
                            </div>`
                        }
                    </div>
                    
                    <h3 class="text-lg font-semibold text-gray-900 mb-2 line-clamp-2">${book.title}</h3>
                    <p class="text-gray-600 mb-2">by ${book.author_name}</p>
                    <p class="text-sm text-gray-500 mb-3">${book.category_name}</p>
                    
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-xl font-bold text-primary-600">$${book.price}</span>
                        <span class="text-xs text-gray-500">Added ${new Date(favorite.created_at).toLocaleDateString()}</span>
                    </div>
                    
                    <div class="flex space-x-2">
                        <button onclick="viewBookDetails(${book.id})" class="flex-1 bg-primary-600 text-white py-2 px-3 rounded-md hover:bg-primary-700 transition-colors text-sm">
                            <i class="fas fa-eye mr-1"></i>
                            View
                        </button>
                        <button onclick="removeFavorite(${favorite.id})" class="bg-red-500 text-white py-2 px-3 rounded-md hover:bg-red-600 transition-colors">
                            <i class="fas fa-heart-broken"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
    }

    async function removeFavorite(favoriteId) {
        if (!confirm('Remove this book from your favorites?')) {
            return;
        }

        try {
            await api.removeFavorite(favoriteId);
            showSuccess('Removed from favorites!');
            loadFavorites(); // Reload the list
        } catch (error) {
            console.error('Error removing favorite:', error);
            showError('Failed to remove favorite.');
        }
    }

    async function viewBookDetails(bookId) {
        try {
            const book = await api.getBook(bookId);
            showBookModal(book);
        } catch (error) {
            console.error('Error loading book details:', error);
            showError('Failed to load book details.');
        }
    }

    function showBookModal(book) {
        // Create modal HTML
        const modalHTML = `
            <div id="book-detail-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 z-50">
                <div class="flex items-center justify-center min-h-screen p-4">
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full p-6">
                        <div class="flex justify-between items-start mb-4">
                            <h3 class="text-xl font-semibold">${book.title}</h3>
                            <button onclick="closeBookModal()" class="text-gray-400 hover:text-gray-600">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                ${book.cover_image ? 
                                    `<img src="${book.cover_image}" alt="${book.title}" class="w-full rounded-md">` :
                                    `<div class="w-full h-64 bg-gray-200 rounded-md flex items-center justify-center">
                                        <i class="fas fa-book text-6xl text-gray-400"></i>
                                    </div>`
                                }
                            </div>
                            <div class="space-y-4">
                                <div>
                                    <h4 class="font-semibold text-gray-900">Author</h4>
                                    <p class="text-gray-600">${book.author.name}</p>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-gray-900">Category</h4>
                                    <p class="text-gray-600">${book.category ? book.category.name : 'N/A'}</p>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-gray-900">ISBN</h4>
                                    <p class="text-gray-600">${book.isbn}</p>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-gray-900">Publication Date</h4>
                                    <p class="text-gray-600">${new Date(book.publication_date).toLocaleDateString()}</p>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-gray-900">Pages</h4>
                                    <p class="text-gray-600">${book.page_count || 'N/A'}</p>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-gray-900">Price</h4>
                                    <p class="text-2xl font-bold text-primary-600">$${book.price}</p>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-gray-900">Description</h4>
                                    <p class="text-gray-600">${book.description || 'No description available.'}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Add modal to page
        document.body.insertAdjacentHTML('beforeend', modalHTML);
    }

    function closeBookModal() {
        const modal = document.getElementById('book-detail-modal');
        if (modal) {
            modal.remove();
        }
    }
</script>
{% endblock %}
