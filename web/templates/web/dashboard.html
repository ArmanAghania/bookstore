{% extends 'web/base.html' %}
{% load static %}

{% block title %}Dashboard - Django Bookstore{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Welcome Section -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900">Welcome back, {{ user.username }}!</h1>
        <p class="mt-2 text-gray-600">Here's what's happening with your account.</p>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="bg-white overflow-hidden shadow rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-heart text-red-500 text-2xl"></i>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Favorite Books</dt>
                            <dd id="favorites-count" class="text-lg font-medium text-gray-900">Loading...</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white overflow-hidden shadow rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-book text-blue-500 text-2xl"></i>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Total Books</dt>
                            <dd id="total-books" class="text-lg font-medium text-gray-900">Loading...</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white overflow-hidden shadow rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-user text-green-500 text-2xl"></i>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Member Since</dt>
                            <dd class="text-lg font-medium text-gray-900">{{ user.date_joined|date:"M Y" }}</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="bg-white shadow rounded-lg mb-8">
        <div class="px-4 py-5 sm:p-6">
            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Quick Actions</h3>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                <a href="{% url 'web:book_management' %}" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 transition-colors">
                    <i class="fas fa-plus mr-2"></i>
                    Add Book
                </a>
                <a href="{% url 'web:favorites' %}" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 transition-colors">
                    <i class="fas fa-heart mr-2"></i>
                    View Favorites
                </a>
                <a href="{% url 'web:home' %}" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 transition-colors">
                    <i class="fas fa-search mr-2"></i>
                    Browse Books
                </a>
                <button onclick="editProfile()" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 transition-colors">
                    <i class="fas fa-edit mr-2"></i>
                    Edit Profile
                </button>
            </div>
        </div>
    </div>

    <!-- Recent Favorites -->
    <div class="bg-white shadow rounded-lg">
        <div class="px-4 py-5 sm:p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Recent Favorites</h3>
                <a href="{% url 'web:favorites' %}" class="text-sm text-primary-600 hover:text-primary-500">View all</a>
            </div>
            <div id="recent-favorites" class="space-y-4">
                <div class="text-center py-8">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600"></div>
                    <p class="mt-2 text-gray-600">Loading favorites...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Profile Edit Modal -->
<div id="profile-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">Edit Profile</h3>
                <button id="close-profile" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="profile-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">First Name</label>
                    <input type="text" id="edit-first-name" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Last Name</label>
                    <input type="text" id="edit-last-name" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Phone Number</label>
                    <input type="tel" id="edit-phone" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Address</label>
                    <textarea id="edit-address" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500"></textarea>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Bio</label>
                    <textarea id="edit-bio" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500"></textarea>
                </div>
                
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" id="cancel-profile" class="px-4 py-2 text-gray-600 hover:text-gray-800">
                        Cancel
                    </button>
                    <button type="submit" class="px-4 py-2 bg-primary-600 text-white rounded-md hover:bg-primary-700 transition-colors">
                        Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Load dashboard data
    document.addEventListener('DOMContentLoaded', function() {
        // Ensure API instance is available
        if (typeof api === 'undefined') {
            console.error('API instance not available');
            showError('API not initialized. Please refresh the page.');
            return;
        }
        
        loadDashboardData();
        setupProfileModal();
    });

    async function loadDashboardData() {
        try {
            // Load total books count
            const books = await api.getBooks();
            document.getElementById('total-books').textContent = books.count || books.length;

            // Load favorites (with error handling)
            try {
                // Check if user is authenticated before trying to load favorites
                const authToken = localStorage.getItem('accessToken');
                if (!authToken) {
                    console.log('User not authenticated, skipping favorites');
                    document.getElementById('favorites-count').textContent = '0';
                    loadRecentFavorites([]);
                } else {
                    const favorites = await api.getFavorites();
                    // Handle both paginated and non-paginated responses
                    const favoritesArray = favorites.results || favorites;
                    
                    if (Array.isArray(favoritesArray)) {
                        document.getElementById('favorites-count').textContent = favoritesArray.length;
                        loadRecentFavorites(favoritesArray.slice(0, 5));
                    } else {
                        // If favorites is not an array, set count to 0
                        document.getElementById('favorites-count').textContent = '0';
                        loadRecentFavorites([]);
                    }
                }
            } catch (favoritesError) {
                console.warn('Could not load favorites:', favoritesError);
                // Set favorites count to 0 if API call fails
                document.getElementById('favorites-count').textContent = '0';
                loadRecentFavorites([]);
            }

        } catch (error) {
            console.error('Error loading dashboard data:', error);
            showError('Failed to load dashboard data.');
        }
    }

    function loadRecentFavorites(favorites) {
        const container = document.getElementById('recent-favorites');
        
        // Ensure favorites is always an array
        if (!Array.isArray(favorites)) {
            favorites = [];
        }
        
        if (favorites.length === 0) {
            container.innerHTML = `
                <div class="text-center py-8">
                    <i class="fas fa-heart text-4xl text-gray-300 mb-4"></i>
                    <h4 class="text-lg font-medium text-gray-600 mb-2">No favorites yet</h4>
                    <p class="text-gray-500 mb-4">Start adding books to your favorites!</p>
                    <a href="{% url 'web:home' %}" class="inline-flex items-center px-4 py-2 bg-primary-600 text-white rounded-md hover:bg-primary-700 transition-colors">
                        <i class="fas fa-search mr-2"></i>
                        Browse Books
                    </a>
                </div>
            `;
            return;
        }

        container.innerHTML = favorites.map(favorite => {
            // Get cover image (uploaded or URL) - same logic as home page
            const coverImage = favorite.book.cover_image_display || favorite.book.cover_image || favorite.book.cover_image_url;
            
            return `
            <div class="flex items-center space-x-4 p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                <div class="flex-shrink-0">
                    ${coverImage ? 
                        `<img src="${coverImage}" alt="${favorite.book.title}" class="w-12 h-16 object-cover rounded" 
                             onerror="this.onerror=null; this.parentNode.innerHTML='<div class=\\'w-12 h-16 bg-gray-200 rounded flex items-center justify-center\\'><i class=\\'fas fa-book text-gray-400\\'></i></div>'">` :
                        `<div class="w-12 h-16 bg-gray-200 rounded flex items-center justify-center">
                            <i class="fas fa-book text-gray-400"></i>
                        </div>`
                    }
                </div>
                <div class="flex-1 min-w-0">
                    <h4 class="text-sm font-medium text-gray-900 truncate">${favorite.book.title}</h4>
                    <p class="text-sm text-gray-500">by ${favorite.book.author_name}</p>
                    <p class="text-sm text-gray-500">$${favorite.book.price}</p>
                </div>
                <div class="flex-shrink-0">
                    <button onclick="removeFavorite(${favorite.id})" class="text-red-500 hover:text-red-700 transition-colors">
                        <i class="fas fa-heart-broken"></i>
                    </button>
                </div>
            </div>
        `;
        }).join('');
    }

    async function removeFavorite(favoriteId) {
        try {
            await api.removeFavorite(favoriteId);
            showSuccess('Removed from favorites!');
            loadDashboardData(); // Reload data
        } catch (error) {
            console.error('Error removing favorite:', error);
            showError('Failed to remove favorite.');
        }
    }

    function setupProfileModal() {
        const profileModal = document.getElementById('profile-modal');
        const closeProfile = document.getElementById('close-profile');
        const cancelProfile = document.getElementById('cancel-profile');
        const profileForm = document.getElementById('profile-form');

        // Load current user data
        api.getCurrentUser().then(user => {
            document.getElementById('edit-first-name').value = user.first_name || '';
            document.getElementById('edit-last-name').value = user.last_name || '';
            document.getElementById('edit-phone').value = user.phone_number || '';
            document.getElementById('edit-address').value = user.address || '';
            document.getElementById('edit-bio').value = user.bio || '';
        });

        // Close modal
        closeProfile.addEventListener('click', () => {
            profileModal.classList.add('hidden');
        });

        cancelProfile.addEventListener('click', () => {
            profileModal.classList.add('hidden');
        });

        // Submit form
        profileForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const userData = {
                first_name: document.getElementById('edit-first-name').value,
                last_name: document.getElementById('edit-last-name').value,
                phone_number: document.getElementById('edit-phone').value,
                address: document.getElementById('edit-address').value,
                bio: document.getElementById('edit-bio').value
            };

            try {
                await api.updateUser(userData);
                showSuccess('Profile updated successfully!');
                profileModal.classList.add('hidden');
                // Reload page to show updated data
                setTimeout(() => location.reload(), 1000);
            } catch (error) {
                console.error('Error updating profile:', error);
                showError('Failed to update profile.');
            }
        });
    }

    function editProfile() {
        document.getElementById('profile-modal').classList.remove('hidden');
    }
</script>
{% endblock %}
