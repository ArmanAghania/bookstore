{% extends 'web/base.html' %}
{% load static %}

{% block title %}Home - Django Bookstore{% endblock %}

{% block content %}
<!-- Hero Section -->
<div class="bg-gradient-to-r from-primary-600 to-primary-800 text-white">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-16">
        <div class="text-center">
            <h1 class="text-4xl md:text-6xl font-bold mb-6">
                Welcome to Our Bookstore
            </h1>
            <p class="text-xl md:text-2xl mb-8 text-primary-100">
                Discover thousands of books from your favorite authors
            </p>
            <div class="flex flex-col sm:flex-row gap-4 justify-center">
                <a href="#books" class="bg-white text-primary-600 px-8 py-3 rounded-lg font-semibold hover:bg-gray-100 transition-colors">
                    Browse Books
                </a>
                {% if not user.is_authenticated %}
                <a href="{% url 'web:register' %}" class="border-2 border-white text-white px-8 py-3 rounded-lg font-semibold hover:bg-white hover:text-primary-600 transition-colors">
                    Join Now
                </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Search Section -->
<div class="bg-white py-12">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="text-center mb-8">
            <h2 class="text-3xl font-bold text-gray-900 mb-4">Find Your Next Read</h2>
            <p class="text-gray-600">Search through our extensive collection of books</p>
        </div>
        
        <div class="max-w-2xl mx-auto">
            <div class="relative">
                <input 
                    type="text" 
                    id="search-input"
                    placeholder="Search books, authors, or categories..."
                    class="w-full px-4 py-3 pl-12 pr-4 text-gray-900 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                >
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <i class="fas fa-search text-gray-400"></i>
                </div>
                <button 
                    id="search-btn"
                    class="absolute inset-y-0 right-0 px-4 bg-primary-600 text-white rounded-r-lg hover:bg-primary-700 transition-colors"
                >
                    Search
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Books Section -->
<div id="books" class="py-16 bg-gray-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center mb-8">
            <h2 class="text-3xl font-bold text-gray-900">Featured Books</h2>
            <div class="flex gap-2">
                <button id="filter-btn" class="px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                    <i class="fas fa-filter mr-2"></i>Filter
                    <span id="filter-count" class="hidden ml-1 bg-primary-600 text-white text-xs rounded-full px-2 py-1">0</span>
                </button>
                <button id="clear-all-filters" class="px-4 py-2 bg-red-50 border border-red-200 text-red-700 rounded-lg hover:bg-red-100 transition-colors hidden">
                    <i class="fas fa-times mr-2"></i>Clear All
                </button>
            </div>
        </div>

        <!-- Loading Spinner -->
        <div id="loading" class="text-center py-8 hidden">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600"></div>
            <p class="mt-2 text-gray-600">Loading books...</p>
        </div>

        <!-- Books Grid -->
        <div id="books-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            <!-- Books will be loaded here via JavaScript -->
        </div>

        <!-- Pagination -->
        <div id="pagination" class="mt-12 flex justify-center">
            <!-- Pagination will be loaded here -->
        </div>
    </div>
</div>

<!-- Filter Modal -->
<div id="filter-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4 overflow-y-auto">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6 my-8 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">Filter Books</h3>
                <button id="close-filter" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="filter-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Category</label>
                    <div class="relative">
                        <input 
                            type="text" 
                            name="category" 
                            id="category-filter" 
                            placeholder="Search categories..."
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500"
                            autocomplete="off"
                        >
                        <div id="category-suggestions" class="absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-y-auto hidden">
                            <!-- Category suggestions will be loaded here -->
                        </div>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Author</label>
                    <div class="relative">
                        <input 
                            type="text" 
                            name="author" 
                            id="author-filter" 
                            placeholder="Search authors..."
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500"
                            autocomplete="off"
                        >
                        <div id="author-suggestions" class="absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-y-auto hidden">
                            <!-- Author suggestions will be loaded here -->
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Min Price</label>
                        <input type="number" name="min_price" id="min-price" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Max Price</label>
                        <input type="number" name="max_price" id="max-price" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500">
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">From Date</label>
                        <input type="date" name="min_publication_date" id="min-publication-date" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">To Date</label>
                        <input type="date" name="max_publication_date" id="max-publication-date" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500">
                    </div>
                </div>
                
                <div class="flex items-center">
                    <input type="checkbox" name="favorites_only" id="favorites-only" class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded">
                    <label for="favorites-only" class="ml-2 block text-sm text-gray-900">
                        Show only my favorites
                    </label>
                </div>
                
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" id="clear-filters" class="px-4 py-2 text-gray-600 hover:text-gray-800">
                        Clear
                    </button>
                    <button type="submit" class="px-4 py-2 bg-primary-600 text-white rounded-md hover:bg-primary-700 transition-colors">
                        Apply Filters
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Book Detail Modal -->
<div id="book-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4 overflow-y-auto">
        <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full p-6 my-8 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-start mb-4">
                <h3 id="book-title" class="text-xl font-semibold"></h3>
                <button id="close-book" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div id="book-details" class="space-y-4 overflow-y-auto">
                <!-- Book details will be loaded here -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Global variables
    let currentPage = 1;
    let currentFilters = {};
    let authToken = localStorage.getItem('accessToken');

    // Function to refresh auth token
    function refreshAuthToken() {
        authToken = localStorage.getItem('accessToken');
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        refreshAuthToken(); // Refresh token on page load
        loadBooks();
        loadCategories();
        loadAuthors();
        setupEventListeners();
    });

    // Event listeners
    function setupEventListeners() {
        document.getElementById('search-btn').addEventListener('click', handleSearch);
        document.getElementById('search-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') handleSearch();
        });
        
        document.getElementById('filter-btn').addEventListener('click', function() {
            document.getElementById('filter-modal').classList.remove('hidden');
        });
        
        document.getElementById('close-filter').addEventListener('click', function() {
            document.getElementById('filter-modal').classList.add('hidden');
        });
        
        document.getElementById('close-book').addEventListener('click', function() {
            document.getElementById('book-modal').classList.add('hidden');
        });
        
        // Click outside to close modals
        document.getElementById('filter-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                this.classList.add('hidden');
            }
        });
        
        document.getElementById('book-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                this.classList.add('hidden');
            }
        });
        
        // Escape key to close modals
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                document.getElementById('filter-modal').classList.add('hidden');
                document.getElementById('book-modal').classList.add('hidden');
            }
        });
        
        document.getElementById('filter-form').addEventListener('submit', handleFilter);
        document.getElementById('clear-filters').addEventListener('click', clearFilters);
        document.getElementById('clear-all-filters').addEventListener('click', clearAllFilters);
    }

    // API functions - use global api instance
    async function apiCall(url, options = {}) {
        // Use the global api instance for consistent authentication handling
        if (typeof api !== 'undefined') {
            // Extract endpoint from full URL
            const endpoint = url.replace('/api', '');
            return await api.request(endpoint, options);
        } else {
            // Fallback to direct fetch if api instance not available
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                }
            };
            
            if (authToken) {
                defaultOptions.headers['Authorization'] = `Bearer ${authToken}`;
            }
            
            const response = await fetch(url, { ...defaultOptions, ...options });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            return await response.json();
        }
    }

    // Load books
    async function loadBooks(page = 1, filters = {}) {
        try {
            showLoading(true);
            currentPage = page;
            currentFilters = filters;
            
            // Use search endpoint for advanced filtering, regular endpoint for basic listing
            let url;
            const hasFilters = Object.keys(filters).length > 0;
            
            if (hasFilters) {
                url = `/api/books/search/?page=${page}`;
            } else {
                url = `/api/books/?page=${page}`;
            }
            
            // Add filters to URL
            if (filters.search) url += `&search=${encodeURIComponent(filters.search)}`;
            if (filters.category) url += `&category=${filters.category}`;
            if (filters.author) url += `&author=${filters.author}`;
            if (filters.min_price) url += `&min_price=${filters.min_price}`;
            if (filters.max_price) url += `&max_price=${filters.max_price}`;
            if (filters.min_publication_date) url += `&min_publication_date=${filters.min_publication_date}`;
            if (filters.max_publication_date) url += `&max_publication_date=${filters.max_publication_date}`;
            if (filters.favorites_only) url += `&favorites_only=${filters.favorites_only}`;
            
            const data = await apiCall(url);
            displayBooks(data.results || data);
            updatePagination(data);
            
        } catch (error) {
            console.error('Error loading books:', error);
            showError('Failed to load books. Please try again.');
        } finally {
            showLoading(false);
        }
    }

    // Load categories for filter (searchable dropdown)
    async function loadCategories() {
        try {
            const categoryInput = document.getElementById('category-filter');
            const suggestionsDiv = document.getElementById('category-suggestions');
            let selectedCategoryId = null;
            let searchTimeout = null;
            
            // Handle category search input
            categoryInput.addEventListener('input', function() {
                const query = this.value.trim();
                
                // Clear previous timeout
                if (searchTimeout) {
                    clearTimeout(searchTimeout);
                }
                
                // Clear suggestions if input is empty
                if (query.length === 0) {
                    suggestionsDiv.classList.add('hidden');
                    selectedCategoryId = null;
                    categoryInput.dataset.selectedCategoryId = '';
                    return;
                }
                
                // Debounce search requests
                searchTimeout = setTimeout(async () => {
                    if (query.length >= 2) {
                        await searchCategories(query);
                    }
                }, 300);
            });
            
            // Handle category selection
            suggestionsDiv.addEventListener('click', function(e) {
                if (e.target.classList.contains('category-suggestion')) {
                    const categoryId = e.target.dataset.categoryId;
                    const categoryName = e.target.textContent;
                    
                    categoryInput.value = categoryName;
                    categoryInput.dataset.selectedCategoryId = categoryId;
                    selectedCategoryId = categoryId;
                    suggestionsDiv.classList.add('hidden');
                }
            });
            
            // Hide suggestions when clicking outside
            document.addEventListener('click', function(e) {
                if (!categoryInput.contains(e.target) && !suggestionsDiv.contains(e.target)) {
                    suggestionsDiv.classList.add('hidden');
                }
            });
            
            console.log('Category search functionality initialized');
        } catch (error) {
            console.error('Error initializing category search:', error);
        }
    }
    
    // Search categories function
    async function searchCategories(query) {
        try {
            const suggestionsDiv = document.getElementById('category-suggestions');
            
            // Use the search endpoint to find categories
            const response = await apiCall(`/api/categories/?search=${encodeURIComponent(query)}`);
            const categories = response.results || response;
            
            if (Array.isArray(categories) && categories.length > 0) {
                suggestionsDiv.innerHTML = '';
                
                categories.slice(0, 10).forEach(category => { // Limit to 10 suggestions
                    const suggestion = document.createElement('div');
                    suggestion.className = 'category-suggestion px-3 py-2 hover:bg-gray-100 cursor-pointer';
                    suggestion.dataset.categoryId = category.id;
                    suggestion.textContent = category.name;
                    suggestionsDiv.appendChild(suggestion);
                });
                
                suggestionsDiv.classList.remove('hidden');
            } else {
                suggestionsDiv.classList.add('hidden');
            }
        } catch (error) {
            console.error('Error searching categories:', error);
        }
    }

    // Load authors for filter (searchable dropdown)
    async function loadAuthors() {
        try {
            const authorInput = document.getElementById('author-filter');
            const suggestionsDiv = document.getElementById('author-suggestions');
            let selectedAuthorId = null;
            let searchTimeout = null;
            
            // Handle author search input
            authorInput.addEventListener('input', function() {
                const query = this.value.trim();
                
                // Clear previous timeout
                if (searchTimeout) {
                    clearTimeout(searchTimeout);
                }
                
                // Clear suggestions if input is empty
                if (query.length === 0) {
                    suggestionsDiv.classList.add('hidden');
                    selectedAuthorId = null;
                    authorInput.dataset.selectedAuthorId = '';
                    return;
                }
                
                // Debounce search requests
                searchTimeout = setTimeout(async () => {
                    if (query.length >= 2) {
                        await searchAuthors(query);
                    }
                }, 300);
            });
            
            // Handle author selection
            suggestionsDiv.addEventListener('click', function(e) {
                if (e.target.classList.contains('author-suggestion')) {
                    const authorId = e.target.dataset.authorId;
                    const authorName = e.target.textContent;
                    
                    authorInput.value = authorName;
                    authorInput.dataset.selectedAuthorId = authorId;
                    selectedAuthorId = authorId;
                    suggestionsDiv.classList.add('hidden');
                }
            });
            
            // Hide suggestions when clicking outside
            document.addEventListener('click', function(e) {
                if (!authorInput.contains(e.target) && !suggestionsDiv.contains(e.target)) {
                    suggestionsDiv.classList.add('hidden');
                }
            });
            
            console.log('Author search functionality initialized');
        } catch (error) {
            console.error('Error initializing author search:', error);
        }
    }
    
    // Search authors function
    async function searchAuthors(query) {
        try {
            const suggestionsDiv = document.getElementById('author-suggestions');
            
            // Use the search endpoint to find authors
            const response = await apiCall(`/api/authors/?search=${encodeURIComponent(query)}`);
            const authors = response.results || response;
            
            if (Array.isArray(authors) && authors.length > 0) {
                suggestionsDiv.innerHTML = '';
                
                authors.slice(0, 10).forEach(author => { // Limit to 10 suggestions
                    const suggestion = document.createElement('div');
                    suggestion.className = 'author-suggestion px-3 py-2 hover:bg-gray-100 cursor-pointer';
                    suggestion.dataset.authorId = author.id;
                    suggestion.textContent = author.name;
                    suggestionsDiv.appendChild(suggestion);
                });
                
                suggestionsDiv.classList.remove('hidden');
            } else {
                suggestionsDiv.classList.add('hidden');
            }
        } catch (error) {
            console.error('Error searching authors:', error);
        }
    }

    // Display books
    function displayBooks(books) {
        const grid = document.getElementById('books-grid');
        grid.innerHTML = '';
        
        if (books.length === 0) {
            grid.innerHTML = `
                <div class="col-span-full text-center py-12">
                    <i class="fas fa-book text-6xl text-gray-300 mb-4"></i>
                    <h3 class="text-xl font-semibold text-gray-600 mb-2">No books found</h3>
                    <p class="text-gray-500">Try adjusting your search or filters</p>
                </div>
            `;
            return;
        }
        
        books.forEach(book => {
            const bookCard = createBookCard(book);
            grid.appendChild(bookCard);
        });
    }

    // Create enhanced book card with rich data
    function createBookCard(book) {
        const card = document.createElement('div');
        card.className = 'bg-white rounded-lg shadow-md hover:shadow-lg transition-all duration-200 cursor-pointer transform hover:scale-105';
        card.onclick = () => showBookDetails(book);
        
        // Get cover image (uploaded or URL)
        const coverImage = book.cover_image_display || book.cover_image || book.cover_image_url;
        
        card.innerHTML = `
            <div class="relative">
                <div class="aspect-w-3 aspect-h-4 mb-4">
                    ${coverImage ? 
                        `<img src="${coverImage}" alt="${book.title}" class="w-full h-56 object-cover rounded-t-lg" 
                             onerror="this.onerror=null; this.parentNode.innerHTML='<div class=\\'w-full h-56 bg-gray-200 rounded-t-lg flex items-center justify-center\\'><i class=\\'fas fa-book text-4xl text-gray-400\\'></i></div>'">`
                        :
                        `<div class="w-full h-56 bg-gray-200 rounded-t-lg flex items-center justify-center">
                            <i class="fas fa-book text-4xl text-gray-400"></i>
                        </div>`
                    }
                </div>
                
                <!-- Favorite button overlay -->
                <button 
                    onclick="event.stopPropagation(); toggleFavorite(${book.id})"
                    class="absolute top-2 right-2 p-2 rounded-full bg-white bg-opacity-90 hover:bg-opacity-100 transition-all duration-200 shadow-md"
                >
                    <i class="${book.is_favorited ? 'fas' : 'far'} fa-heart text-red-500"></i>
                </button>
            </div>
            
            <div class="p-4">
                <!-- Title and Author -->
                <h3 class="text-lg font-semibold text-gray-900 mb-1 line-clamp-2">${book.title}</h3>
                <p class="text-gray-600 mb-2">by ${book.author_name}</p>
                
                <!-- Series Info -->
                ${book.series_name ? 
                    `<div class="mb-2">
                        <span class="inline-block bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full">
                            ${book.series_info || book.series_name}
                        </span>
                    </div>` : ''
                }
                
                <!-- Rating Display -->
                ${book.average_rating ? 
                    `<div class="flex items-center mb-2">
                        <div class="flex text-yellow-400 mr-2">
                            ${generateStarRating(book.average_rating)}
                        </div>
                        <span class="text-sm text-gray-600">${book.rating_display || `${book.average_rating}/5.0`}</span>
                    </div>` : ''
                }
                
                <!-- Genres -->
                ${book.genres_display && book.genres_display.length > 0 ? 
                    `<div class="flex flex-wrap gap-1 mb-3">
                        ${book.genres_display.slice(0, 3).map(genre => 
                            `<span class="inline-block bg-gray-100 text-gray-700 text-xs px-2 py-1 rounded">${genre}</span>`
                        ).join('')}
                    </div>` : ''
                }
                
                <!-- Category -->
                ${book.category_name ? `<p class="text-sm text-gray-500 mb-2">${book.category_name}</p>` : ''}
                
                <!-- Book Details -->
                <div class="text-xs text-gray-500 mb-3 space-y-1">
                    ${book.publisher_name ? `<div><i class="fas fa-building mr-1"></i>${book.publisher_name}</div>` : ''}
                    ${book.book_format ? `<div><i class="fas fa-bookmark mr-1"></i>${formatBookFormat(book.book_format)}</div>` : ''}
                    ${book.page_count ? `<div><i class="fas fa-file-alt mr-1"></i>${book.page_count} pages</div>` : ''}
                </div>
                
                <!-- Price and Actions -->
                <div class="flex items-center justify-between">
                    <span class="text-xl font-bold text-primary-600">$${book.price}</span>
                    <button 
                        onclick="event.stopPropagation(); showBookDetails(book)"
                        class="px-3 py-1 bg-blue-500 text-white text-sm rounded hover:bg-blue-600 transition-colors duration-200"
                    >
                        Details
                    </button>
                </div>
            </div>
        `;
        
        return card;
    }
    
    // Generate star rating HTML
    function generateStarRating(rating) {
        const fullStars = Math.floor(rating);
        const hasHalfStar = rating % 1 >= 0.5;
        const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
        
        let stars = '';
        for (let i = 0; i < fullStars; i++) {
            stars += '<i class="fas fa-star"></i>';
        }
        if (hasHalfStar) {
            stars += '<i class="fas fa-star-half-alt"></i>';
        }
        for (let i = 0; i < emptyStars; i++) {
            stars += '<i class="far fa-star"></i>';
        }
        return stars;
    }
    
    // Format book format for display
    function formatBookFormat(format) {
        const formatMap = {
            'hardcover': 'Hardcover',
            'paperback': 'Paperback',
            'mass_paperback': 'Mass Market Paperback',
            'audiobook': 'Audiobook',
            'ebook': 'E-book',
            'board_book': 'Board Book',
            'other': 'Other'
        };
        return formatMap[format] || format;
    }

    // Show book details
    async function showBookDetails(book) {
        try {
            const bookDetail = await apiCall(`/api/books/${book.id}/`);
            
            document.getElementById('book-title').textContent = bookDetail.title;
            
            const details = document.getElementById('book-details');
            const coverImage = bookDetail.cover_image_display || bookDetail.cover_image || bookDetail.cover_image_url;
            
            details.innerHTML = `
                <div class="space-y-6">
                    <!-- Cover and Basic Info -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="md:col-span-1">
                            ${coverImage ? 
                                `<img src="${coverImage}" alt="${bookDetail.title}" class="w-full rounded-lg shadow-md" onerror="this.onerror=null; this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjMwMCIgdmlld0JveD0iMCAwIDIwMCAzMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iMzAwIiBmaWxsPSIjRjNGNEY2Ii8+CjxwYXRoIGQ9Ik0xMDAgMTIwSDgwVjE4MEgxMjBWMTIwSDEwMFoiIGZpbGw9IiM5Q0EzQUYiLz4KPHBhdGggZD0iTTgwIDEyMEgxMjBWMTQwSDgwVjEyMFoiIGZpbGw9IiM2QjcyODAiLz4KPC9zdmc+'; this.alt='No cover available';">` :
                                `<div class="w-full h-80 bg-gray-200 rounded-lg flex items-center justify-center shadow-md">
                                    <i class="fas fa-book text-6xl text-gray-400"></i>
                                </div>`
                            }
                        </div>
                        <div class="md:col-span-2 space-y-4">
                            <div class="flex items-center justify-between">
                                <h2 class="text-2xl font-bold text-gray-900">${bookDetail.title}</h2>
                                <div class="flex items-center space-x-2">
                                    ${bookDetail.average_rating ? `
                                        <div class="flex items-center">
                                            <div class="flex text-yellow-400 mr-2">${generateStarRating(bookDetail.average_rating)}</div>
                                            <span class="text-sm text-gray-600">${bookDetail.rating_display || bookDetail.average_rating}/5.0</span>
                                        </div>
                                    ` : ''}
                                    <button onclick="toggleFavorite(${bookDetail.id})" class="p-2 rounded-full bg-red-50 hover:bg-red-100 transition-colors">
                                        <i class="${bookDetail.is_favorited ? 'fas' : 'far'} fa-heart text-red-500"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <h4 class="font-semibold text-gray-900 mb-1">Author</h4>
                                    <p class="text-gray-600">${bookDetail.author.name}</p>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-gray-900 mb-1">Category</h4>
                                    <p class="text-gray-600">${bookDetail.category ? bookDetail.category.name : 'N/A'}</p>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-gray-900 mb-1">Publisher</h4>
                                    <p class="text-gray-600">${bookDetail.publisher ? bookDetail.publisher.name : 'N/A'}</p>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-gray-900 mb-1">Language</h4>
                                    <p class="text-gray-600">${bookDetail.language ? bookDetail.language.name : 'N/A'}</p>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-gray-900 mb-1">ISBN</h4>
                                    <p class="text-gray-600 font-mono text-sm">${bookDetail.isbn}</p>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-gray-900 mb-1">Publication Date</h4>
                                    <p class="text-gray-600">${new Date(bookDetail.publication_date).toLocaleDateString()}</p>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-gray-900 mb-1">Pages</h4>
                                    <p class="text-gray-600">${bookDetail.page_count || 'N/A'}</p>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-gray-900 mb-1">Format</h4>
                                    <p class="text-gray-600">${bookDetail.book_format ? formatBookFormat(bookDetail.book_format) : 'N/A'}</p>
                                </div>
                            </div>
                            
                            <div class="flex items-center justify-between pt-4 border-t">
                                <div class="text-3xl font-bold text-primary-600">$${bookDetail.price}</div>
                                <button onclick="toggleFavorite(${bookDetail.id})" class="px-6 py-2 bg-primary-600 text-white rounded-md hover:bg-primary-700 transition-colors">
                                    <i class="fas fa-heart mr-2"></i>
                                    ${bookDetail.is_favorited ? 'Remove from Favorites' : 'Add to Favorites'}
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Series Information -->
                    ${bookDetail.series ? `
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-blue-900 mb-2">Series Information</h4>
                            <p class="text-blue-800">${bookDetail.series.name}</p>
                            ${bookDetail.series_info ? `<p class="text-blue-700 text-sm mt-1">${bookDetail.series_info}</p>` : ''}
                        </div>
                    ` : ''}
                    
                    <!-- Genres -->
                    ${bookDetail.genres && bookDetail.genres.length > 0 ? `
                        <div>
                            <h4 class="font-semibold text-gray-900 mb-2">Genres</h4>
                            <div class="flex flex-wrap gap-2">
                                ${bookDetail.genres.map(genre => `
                                    <span class="inline-block bg-gray-100 text-gray-700 text-sm px-3 py-1 rounded-full">${genre.name}</span>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Description -->
                    ${bookDetail.description ? `
                        <div>
                            <h4 class="font-semibold text-gray-900 mb-2">Description</h4>
                            <p class="text-gray-600 leading-relaxed">${bookDetail.description}</p>
                        </div>
                    ` : ''}
                    
                    <!-- Additional Details -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                        ${bookDetail.goodreads_id ? `
                            <div>
                                <h4 class="font-semibold text-gray-900 mb-1">Goodreads ID</h4>
                                <p class="text-gray-600">${bookDetail.goodreads_id}</p>
                            </div>
                        ` : ''}
                        ${bookDetail.first_publication_date ? `
                            <div>
                                <h4 class="font-semibold text-gray-900 mb-1">First Publication</h4>
                                <p class="text-gray-600">${new Date(bookDetail.first_publication_date).toLocaleDateString()}</p>
                            </div>
                        ` : ''}
                        ${bookDetail.edition ? `
                            <div>
                                <h4 class="font-semibold text-gray-900 mb-1">Edition</h4>
                                <p class="text-gray-600">${bookDetail.edition}</p>
                            </div>
                        ` : ''}
                        ${bookDetail.num_ratings ? `
                            <div>
                                <h4 class="font-semibold text-gray-900 mb-1">Total Ratings</h4>
                                <p class="text-gray-600">${bookDetail.num_ratings.toLocaleString()} ratings</p>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
            
            document.getElementById('book-modal').classList.remove('hidden');
        } catch (error) {
            console.error('Error loading book details:', error);
            showError('Failed to load book details.');
        }
    }

    // Toggle favorite
    async function toggleFavorite(bookId) {
        refreshAuthToken(); // Refresh token before checking
        if (!authToken) {
            showError('Please login to add favorites.');
            return;
        }
        
        try {
            const response = await apiCall('/api/favorites/toggle/', {
                method: 'POST',
                body: JSON.stringify({ book_id: bookId })
            });
            
            // Reload books to update favorite status
            loadBooks(currentPage, currentFilters);
            
            if (response.is_favorited) {
                showSuccess('Book added to favorites!');
            } else {
                showSuccess('Book removed from favorites!');
            }
        } catch (error) {
            console.error('Error toggling favorite:', error);
            showError('Failed to update favorites.');
        }
    }

    // Handle search
    function handleSearch() {
        const searchTerm = document.getElementById('search-input').value.trim();
        currentFilters = { ...currentFilters, search: searchTerm };
        currentPage = 1;
        loadBooks(currentPage, currentFilters);
        updateFilterUI();
    }

    // Handle filter
    function handleFilter(e) {
        e.preventDefault();
        
        const formData = new FormData(e.target);
        const categoryInput = document.getElementById('category-filter');
        const authorInput = document.getElementById('author-filter');
        const selectedCategoryId = categoryInput.dataset.selectedCategoryId || '';
        const selectedAuthorId = authorInput.dataset.selectedAuthorId || '';
        
        currentFilters = {
            category: selectedCategoryId || '',
            author: selectedAuthorId || '',
            min_price: formData.get('min_price') || '',
            max_price: formData.get('max_price') || '',
            min_publication_date: formData.get('min_publication_date') || '',
            max_publication_date: formData.get('max_publication_date') || '',
            favorites_only: formData.get('favorites_only') ? 'true' : ''
        };
        
        // Remove empty filters
        Object.keys(currentFilters).forEach(key => {
            if (!currentFilters[key]) delete currentFilters[key];
        });
        
        currentPage = 1;
        loadBooks(currentPage, currentFilters);
        document.getElementById('filter-modal').classList.add('hidden');
        updateFilterUI();
    }

    // Clear filters
    function clearFilters() {
        document.getElementById('filter-form').reset();
        currentFilters = {};
        currentPage = 1;
        loadBooks(currentPage, currentFilters);
        document.getElementById('filter-modal').classList.add('hidden');
        updateFilterUI();
    }

    // Clear all filters (including search)
    function clearAllFilters() {
        document.getElementById('filter-form').reset();
        document.getElementById('search-input').value = '';
        currentFilters = {};
        currentPage = 1;
        loadBooks(currentPage, currentFilters);
        updateFilterUI();
    }

    // Update filter UI indicators
    function updateFilterUI() {
        const filterCount = Object.keys(currentFilters).length;
        const filterCountElement = document.getElementById('filter-count');
        const clearAllButton = document.getElementById('clear-all-filters');
        
        if (filterCount > 0) {
            filterCountElement.textContent = filterCount;
            filterCountElement.classList.remove('hidden');
            clearAllButton.classList.remove('hidden');
        } else {
            filterCountElement.classList.add('hidden');
            clearAllButton.classList.add('hidden');
        }
    }

    // Update pagination
    function updatePagination(data) {
        const pagination = document.getElementById('pagination');
        
        // Check if we have pagination data
        if (!data.next && !data.previous && currentPage === 1) {
            pagination.innerHTML = '';
            return;
        }
        
        let paginationHTML = '<nav class="flex justify-center items-center space-x-2">';
        
        // Previous button
        if (data.previous) {
            paginationHTML += `<button onclick="loadBooks(${currentPage - 1}, currentFilters)" class="px-3 py-2 bg-white border border-gray-300 rounded-md hover:bg-gray-50 text-sm">Previous</button>`;
        } else {
            paginationHTML += `<button disabled class="px-3 py-2 bg-gray-100 border border-gray-300 rounded-md text-gray-400 text-sm cursor-not-allowed">Previous</button>`;
        }
        
        // Page numbers (show current page and a few around it)
        const totalPages = Math.ceil(data.count / 20); // Assuming 20 items per page
        const startPage = Math.max(1, currentPage - 2);
        const endPage = Math.min(totalPages, currentPage + 2);
        
        if (startPage > 1) {
            paginationHTML += `<button onclick="loadBooks(1, currentFilters)" class="px-3 py-2 bg-white border border-gray-300 rounded-md hover:bg-gray-50 text-sm">1</button>`;
            if (startPage > 2) {
                paginationHTML += `<span class="px-2 text-gray-500">...</span>`;
            }
        }
        
        for (let i = startPage; i <= endPage; i++) {
            if (i === currentPage) {
                paginationHTML += `<button class="px-3 py-2 bg-primary-600 text-white border border-primary-600 rounded-md text-sm">${i}</button>`;
            } else {
                paginationHTML += `<button onclick="loadBooks(${i}, currentFilters)" class="px-3 py-2 bg-white border border-gray-300 rounded-md hover:bg-gray-50 text-sm">${i}</button>`;
            }
        }
        
        if (endPage < totalPages) {
            if (endPage < totalPages - 1) {
                paginationHTML += `<span class="px-2 text-gray-500">...</span>`;
            }
            paginationHTML += `<button onclick="loadBooks(${totalPages}, currentFilters)" class="px-3 py-2 bg-white border border-gray-300 rounded-md hover:bg-gray-50 text-sm">${totalPages}</button>`;
        }
        
        // Next button
        if (data.next) {
            paginationHTML += `<button onclick="loadBooks(${currentPage + 1}, currentFilters)" class="px-3 py-2 bg-white border border-gray-300 rounded-md hover:bg-gray-50 text-sm">Next</button>`;
        } else {
            paginationHTML += `<button disabled class="px-3 py-2 bg-gray-100 border border-gray-300 rounded-md text-gray-400 text-sm cursor-not-allowed">Next</button>`;
        }
        
        // Show total count
        if (data.count) {
            paginationHTML += `<span class="ml-4 text-sm text-gray-600">Showing ${((currentPage - 1) * 20) + 1}-${Math.min(currentPage * 20, data.count)} of ${data.count} books</span>`;
        }
        
        paginationHTML += '</nav>';
        pagination.innerHTML = paginationHTML;
    }

    // Utility functions
    function showLoading(show) {
        document.getElementById('loading').classList.toggle('hidden', !show);
    }

    function showError(message) {
        // You can implement a toast notification system here
        alert(message);
    }

    function showSuccess(message) {
        // You can implement a toast notification system here
        alert(message);
    }
</script>
{% endblock %}
